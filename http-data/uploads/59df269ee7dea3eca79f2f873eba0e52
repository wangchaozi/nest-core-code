import os
import sys
import cv2
import numpy as np
from concurrent.futures import ThreadPoolExecutor
from PyQt5.QtWidgets import *
from PyQt5.QtCore import *
from PyQt5.QtGui import *
from ultralytics import YOLO
from PyQt5.QtCore import pyqtSlot

# ä¿®å¤Linuxç¯å¢ƒå˜é‡é—®é¢˜
if "XDG_RUNTIME_DIR" not in os.environ:
    os.environ["XDG_RUNTIME_DIR"] = f"/tmp/runtime-{os.getuid()}"
    os.makedirs(os.environ["XDG_RUNTIME_DIR"], exist_ok=True)


class DetectionThread(QThread):
    finished = pyqtSignal(list)
    progress = pyqtSignal(int)

    def __init__(self, model, image_paths):
        super().__init__()
        self.model = model
        self.image_paths = image_paths

    def run(self):
        results = []
        try:
            for i, path in enumerate(self.image_paths):
                result = self.model.predict(path, conf=0.5, save=False, verbose=False)[0]
                results.append((path, result))
                self.progress.emit(int((i + 1) / len(self.image_paths) * 100))
        except Exception as e:
            print(f"æ£€æµ‹é”™è¯¯: {str(e)}")
        finally:
            self.finished.emit(results)


class ImageLoader(QRunnable):
    class Signals(QObject):
        loaded = pyqtSignal(int, QImage, QImage)  # ç´¢å¼•, åŸå›¾, ç¼©ç•¥å›¾
        error = pyqtSignal(int, str)

    def __init__(self, path, index):
        super().__init__()
        self.path = path
        self.index = index
        self.signals = self.Signals()

    def run(self):
        try:
            # ä½¿ç”¨æ·±æ‹·è´é¿å…å†…å­˜é—®é¢˜
            img = cv2.imread(self.path)
            if img is None:
                raise ValueError("æ— æ•ˆçš„å›¾ç‰‡æ–‡ä»¶")

            img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
            h, w, ch = img.shape
            img_data = np.ascontiguousarray(img.copy())  # åˆ›å»ºæ·±æ‹·è´

            # ç”ŸæˆQImageå¯¹è±¡
            qimg = QImage(img_data.data, w, h, ch * w, QImage.Format_RGB888)
            thumbnail = qimg.scaled(100, 100, Qt.KeepAspectRatio, Qt.SmoothTransformation)

            self.signals.loaded.emit(self.index, qimg.copy(), thumbnail.copy())
        except Exception as e:
            self.signals.error.emit(self.index, str(e))


class CrackDetectionApp(QMainWindow):
    def __init__(self):
        super().__init__()
        try:
            self.model = YOLO('./best.pt')
        except Exception as e:
            QMessageBox.critical(self, 'æ¨¡å‹åŠ è½½å¤±è´¥', f'æ— æ³•åŠ è½½æ¨¡å‹: {str(e)}')
            sys.exit(1)

        # åˆå§‹åŒ–æ•°æ®
        self.image_paths = []
        self.original_images = []
        self.result_images = []
        self.original_thumbs = []
        self.result_thumbs = []
        self.current_index = 0
        self.show_mode = "original"
        self.thread_pool = ThreadPoolExecutor(max_workers=4)
        self.failed_loads = set()
        self.scroll_pos = 0

        self.init_ui()
        self.init_animations()

    def init_ui(self):
        self.setWindowTitle('æ™ºèƒ½è£‚ç¼æ£€æµ‹ç³»ç»Ÿ')
        self.setGeometry(100, 100, 1280, 800)
        self.setStyleSheet("""
            QMainWindow { background-color: #2E2E2E; }
            QLabel { color: white; }
            QPushButton {
                background-color: #4CAF50;
                border: none;
                color: white;
                padding: 8px 16px;
                font-size: 14px;
                border-radius: 5px;
            }
            QPushButton:hover { background-color: #45a049; }
            QListWidget {
                background-color: #404040;
                color: white;
                border-radius: 5px;
                padding: 5px;
                outline: none;
            }
            QListWidget::item {
                padding: 8px;
                border-bottom: 1px solid #555;
            }
            QListWidget::item:selected { 
                background-color: #4CAF5050; 
                border-left: 3px solid #4CAF50;
            }
        """)

        # ä¸»å¸ƒå±€
        main_widget = QWidget()
        self.setCentralWidget(main_widget)
        main_layout = QHBoxLayout(main_widget)

        # å·¦ä¾§æ˜¾ç¤ºåŒºåŸŸ
        left_widget = QWidget()
        left_layout = QVBoxLayout(left_widget)

        # ä¸»å›¾æ˜¾ç¤º
        self.image_label = QLabel()
        self.image_label.setAlignment(Qt.AlignCenter)
        self.image_label.setStyleSheet("background-color: #404040; border-radius: 10px; padding: 10px;")
        left_layout.addWidget(self.image_label)

        # æ§åˆ¶é¢æ¿
        control_widget = QWidget()
        control_layout = QHBoxLayout(control_widget)

        self.prev_btn = QPushButton("â† ä¸Šä¸€å¼ ")
        self.next_btn = QPushButton("ä¸‹ä¸€å¼  â†’")
        self.mode_btn = QPushButton("åˆ‡æ¢åˆ°æ£€æµ‹ç»“æœ")

        self.prev_btn.clicked.connect(self.show_prev)
        self.next_btn.clicked.connect(self.show_next)
        self.mode_btn.clicked.connect(self.toggle_mode)

        control_layout.addWidget(self.prev_btn)
        control_layout.addWidget(self.next_btn)
        control_layout.addWidget(self.mode_btn)
        left_layout.addWidget(control_widget)

        # å³ä¾§é¢æ¿
        right_widget = QWidget()
        right_layout = QVBoxLayout(right_widget)

        # ä¸Šä¼ æŒ‰é’®
        upload_btn = QPushButton('ğŸ“ ä¸Šä¼ å›¾ç‰‡')
        upload_btn.clicked.connect(self.upload_images)
        right_layout.addWidget(upload_btn)

        # ç¼©ç•¥å›¾åˆ—è¡¨
        self.thumbnail_list = QListWidget()
        self.thumbnail_list.setIconSize(QSize(100, 100))
        self.thumbnail_list.itemClicked.connect(self.on_thumbnail_click)
        self.thumbnail_list.verticalScrollBar().valueChanged.connect(self.handle_scroll)

        scroll = QScrollArea()
        scroll.setWidgetResizable(True)
        scroll.setWidget(self.thumbnail_list)
        right_layout.addWidget(scroll)

        # è¿›åº¦æ¡
        self.progress_bar = QProgressBar()
        self.progress_bar.setTextVisible(False)
        self.progress_bar.setStyleSheet("""
            QProgressBar { height: 6px; border-radius: 3px; background: #555; }
            QProgressBar::chunk { background: #4CAF50; border-radius: 3px; }
        """)
        right_layout.addWidget(self.progress_bar)

        # æ“ä½œæŒ‰é’®
        btn_widget = QWidget()
        btn_layout = QVBoxLayout(btn_widget)

        self.detect_btn = QPushButton('ğŸ” å¼€å§‹æ£€æµ‹')
        self.save_btn = QPushButton('ğŸ’¾ ä¿å­˜å½“å‰')
        self.compare_btn = QPushButton('ğŸ”„ å¯¹æ¯”è§†å›¾')
        self.batch_save_btn = QPushButton('ğŸ’¾ æ‰¹é‡ä¿å­˜')

        self.detect_btn.clicked.connect(self.start_detection)
        self.save_btn.clicked.connect(self.save_current)
        self.compare_btn.clicked.connect(self.show_compare)
        self.batch_save_btn.clicked.connect(self.add_batch_save)

        btn_layout.addWidget(self.detect_btn)
        btn_layout.addWidget(self.save_btn)
        btn_layout.addWidget(self.compare_btn)
        btn_layout.addWidget(self.batch_save_btn)
        right_layout.addWidget(btn_widget)

        # å¸ƒå±€åˆ†é…
        main_layout.addWidget(left_widget, 70)
        main_layout.addWidget(right_widget, 30)

        self.update_ui_state()

    def init_animations(self):
        """åˆå§‹åŒ–åŠ¨ç”»æ•ˆæœ"""
        self.thumbnail_list.setProperty("opacity", 1.0)
        self.fade_animation = QPropertyAnimation(self.thumbnail_list, b"opacity")
        self.fade_animation.setDuration(300)

        self.scroll_animation = QPropertyAnimation(self.thumbnail_list.verticalScrollBar(), b"value")
        self.scroll_animation.setDuration(500)
        self.scroll_animation.setEasingCurve(QEasingCurve.OutQuad)

    def handle_scroll(self, value):
        """å¤„ç†æ»šåŠ¨äº‹ä»¶å®ç°è™šæ‹Ÿåˆ—è¡¨"""
        if abs(value - self.scroll_pos) > 100:
            self.update_thumbnails()
        self.scroll_pos = value

    def update_ui_state(self):
        """æ›´æ–°ç•Œé¢å…ƒç´ çŠ¶æ€"""
        has_images = len(self.image_paths) > 0
        has_results = len(self.result_images) > 0

        self.detect_btn.setEnabled(has_images)
        self.save_btn.setEnabled(has_images)
        self.compare_btn.setEnabled(has_results)
        self.mode_btn.setEnabled(has_results)

        if has_results:
            self.mode_btn.setText("åˆ‡æ¢åˆ°æ£€æµ‹ç»“æœ" if self.show_mode == "original" else "åˆ‡æ¢åˆ°åŸå§‹å›¾ç‰‡")

    def upload_images(self):
        """å¼‚æ­¥ä¸Šä¼ å›¾ç‰‡"""
        paths, _ = QFileDialog.getOpenFileNames(self, 'é€‰æ‹©å›¾ç‰‡', '', 'å›¾ç‰‡æ–‡ä»¶ (*.jpg *.jpeg *.png)')
        if not paths:
            return

        # é‡ç½®çŠ¶æ€
        self.image_paths = paths
        self.original_images = [None] * len(paths)
        self.original_thumbs = [None] * len(paths)
        self.result_images = []
        self.result_thumbs = []
        self.failed_loads.clear()

        # åˆå§‹åŒ–ç¼©ç•¥å›¾åˆ—è¡¨
        self.thumbnail_list.clear()
        for idx in range(len(paths)):
            item = QListWidgetItem(QIcon(":/icons/loading.png"), "åŠ è½½ä¸­...")
            self.thumbnail_list.insertItem(idx, item)

        # å¯åŠ¨å¼‚æ­¥åŠ è½½
        for idx, path in enumerate(paths):
            loader = ImageLoader(path, idx)
            loader.signals.loaded.connect(self.handle_image_loaded)
            loader.signals.error.connect(self.handle_image_error)
            self.thread_pool.submit(loader.run)

        self.show_mode = "original"
        self.current_index = 0
        self.update_ui_state()

    @pyqtSlot(int, QImage, QImage)
    def handle_image_loaded(self, index, qimg, thumbnail):
        """åœ¨ä¸»çº¿ç¨‹å¤„ç†å›¾åƒåŠ è½½"""
        try:
            # è½¬æ¢ä¸ºQPixmap
            pixmap = QPixmap.fromImage(qimg)
            thumb = QPixmap.fromImage(thumbnail)

            # æ›´æ–°æ•°æ®
            self.original_images[index] = pixmap
            self.original_thumbs[index] = thumb

            # æ›´æ–°ç¼©ç•¥å›¾æ˜¾ç¤º
            if self.thumbnail_list.count() > index:
                item = self.thumbnail_list.item(index)
                item.setIcon(QIcon(thumb))
                item.setText(f"ğŸ“· {self.get_filename(index)}")

            # æ˜¾ç¤ºå½“å‰å›¾ç‰‡
            if index == self.current_index:
                self.display_current()
        except Exception as e:
            print(f"å›¾åƒå¤„ç†å¤±è´¥: {str(e)}")

    @pyqtSlot(int, str)
    def handle_image_error(self, index, error_msg):
        """å¤„ç†åŠ è½½é”™è¯¯"""
        self.failed_loads.add(index)
        print(f"å›¾ç‰‡åŠ è½½å¤±è´¥: index={index}, error={error_msg}")

        # æ›´æ–°ç¼©ç•¥å›¾æ˜¾ç¤º
        if self.thumbnail_list.count() > index:
            item = self.thumbnail_list.item(index)
            item.setIcon(QIcon(":/icons/error.png"))
            item.setText(f"âŒ åŠ è½½å¤±è´¥")

    def update_thumbnails(self):
        """ä¼˜åŒ–åçš„è™šæ‹Ÿåˆ—è¡¨å®ç°"""
        # è·å–å½“å‰å¯è§èŒƒå›´
        scroll_bar = self.thumbnail_list.verticalScrollBar()
        start_idx = max(0, scroll_bar.value() // 110 - 2)
        end_idx = min(len(self.image_paths), start_idx + (self.thumbnail_list.height() // 110) + 4)

        # æ›´æ–°å¯è§é¡¹
        for idx in range(start_idx, end_idx):
            if 0 <= idx < len(self.original_thumbs):
                status = "âœ…" if self.show_mode == "results" else "ğŸ“·"
                if self.original_thumbs[idx]:
                    thumb = self.original_thumbs[idx]
                    text = f"{status} {self.get_filename(idx)}"
                else:
                    thumb = QPixmap(":/icons/loading.png")
                    text = "åŠ è½½ä¸­..." if idx not in self.failed_loads else "âŒ åŠ è½½å¤±è´¥"

                if idx >= self.thumbnail_list.count():
                    item = QListWidgetItem()
                    self.thumbnail_list.insertItem(idx, item)
                else:
                    item = self.thumbnail_list.item(idx)

                item.setIcon(QIcon(thumb))
                item.setText(text)

        # é«˜äº®å½“å‰é¡¹
        if 0 <= self.current_index < self.thumbnail_list.count():
            self.thumbnail_list.setCurrentRow(self.current_index)

    # ...ï¼ˆå…¶ä»–æ–¹æ³•ä¿æŒä¸å˜ï¼ŒåŒ…æ‹¬start_detection, process_result, save_currentç­‰ï¼‰...
    def display_current(self):
        """æ˜¾ç¤ºå½“å‰å›¾ç‰‡"""
        if self.show_mode == "original":
            pixmap = self.original_images[self.current_index] if self.current_index < len(
                self.original_images) else None
        else:
            pixmap = self.result_images[self.current_index] if self.current_index < len(self.result_images) else None

        if pixmap:
            scaled = pixmap.scaled(
                self.image_label.width() - 20,
                self.image_label.height() - 20,
                Qt.KeepAspectRatio,
                Qt.SmoothTransformation
            )
            self.image_label.setPixmap(scaled)

    def get_filename(self, index):
        """è·å–å¸¦åºå·çš„æ–‡ä»¶å"""
        if 0 <= index < len(self.image_paths):
            base = os.path.basename(self.image_paths[index])
            return f"{index + 1}. {base}"
        return "æœªçŸ¥æ–‡ä»¶"

    def on_thumbnail_click(self, item):
        index = self.thumbnail_list.row(item)  # æ­£ç¡®è·å–åˆ—è¡¨é¡¹çš„ç´¢å¼•
        if 0 <= index < len(self.image_paths):
            self.current_index = index
            self.display_current()
            self.highlight_current_item()

    def add_batch_save(self):
        """æ‰¹é‡ä¿å­˜åŠŸèƒ½ï¼ˆä¿®å¤æ ‡é¢˜å’Œæ˜¾ç¤ºé—®é¢˜ï¼‰"""
        if not self.result_images:
            QMessageBox.warning(self, "æç¤º", "è¯·å…ˆå®Œæˆæ£€æµ‹")
            return

        # ä¿®å¤1ï¼šè®¾ç½®æ­£ç¡®çš„å¯¹è¯æ¡†æ ‡é¢˜
        save_dir = QFileDialog.getExistingDirectory(
            self,
            "é€‰æ‹©ä¿å­˜ç›®å½• - æ‰¹é‡ä¿å­˜",  # ä¿®æ”¹å¯¹è¯æ¡†æ ‡é¢˜
            options=QFileDialog.ShowDirsOnly
        )
        if not save_dir:
            return

        # ä¿®å¤2ï¼šåˆ›å»ºæ— å¹²æ‰°çš„è¿›åº¦å¯¹è¯æ¡†
        progress = QProgressDialog(
            "æ­£åœ¨æ‰¹é‡ä¿å­˜...",
            "å–æ¶ˆ",
            0,
            len(self.result_images),
            self
        )
        progress.setWindowTitle("æ‰¹é‡ä¿å­˜è¿›åº¦")  # è®¾ç½®è¿›åº¦çª—å£æ ‡é¢˜
        progress.setWindowModality(Qt.WindowModal)
        progress.setMinimumDuration(0)  # ç«‹å³æ˜¾ç¤ºè¿›åº¦æ¡

        # ä¿®å¤3ï¼šç¦ç”¨ä¸»çª—å£äº¤äº’é˜²æ­¢åˆ·æ–°
        self.setEnabled(False)

        try:
            for idx, pixmap in enumerate(self.result_images):
                if progress.wasCanceled():
                    break

                # ä¿®å¤4ï¼šä¸è§¦å‘ä»»ä½•ç•Œé¢æ›´æ–°
                path = os.path.join(save_dir, f"result_{idx + 1}.png")

                # ä½¿ç”¨åå°çº¿ç¨‹ä¿å­˜ï¼ˆé¿å…ç•Œé¢å†»ç»“ï¼‰
                with ThreadPoolExecutor(max_workers=1) as executor:
                    future = executor.submit(pixmap.save, path, quality=100)
                    while not future.done():
                        QApplication.processEvents()  # ä¿æŒå“åº”

                progress.setValue(idx + 1)

            # ä¿®å¤5ï¼šå®Œæˆæç¤ºåŒ…å«è¯¦ç»†ä¿¡æ¯
            QMessageBox.information(
                self,
                "æ‰¹é‡ä¿å­˜å®Œæˆ",  # ä¿®æ”¹å®Œæˆæç¤ºæ ‡é¢˜
                f"æˆåŠŸä¿å­˜ {progress.value()} å¼ å›¾ç‰‡åˆ°ï¼š\n{save_dir}"
            )
        except Exception as e:
            QMessageBox.critical(
                self,
                "ä¿å­˜é”™è¯¯",
                f"æ‰¹é‡ä¿å­˜å¤±è´¥ï¼š{str(e)}"
            )
        finally:
            self.setEnabled(True)
            progress.close()

    def start_detection(self):
        """å¼€å§‹æ£€æµ‹"""
        if not self.image_paths:
            return

        self.thread = DetectionThread(self.model, self.image_paths)
        self.thread.finished.connect(self.on_detection_finish)
        self.thread.progress.connect(self.progress_bar.setValue)
        self.thread.start()
        self.detect_btn.setEnabled(False)

    def on_detection_finish(self, results):
        """æ£€æµ‹å®Œæˆå¤„ç†"""
        self.result_images.clear()

        try:
            for path, result in results:
                # å¤„ç†ç»“æœå›¾åƒ
                plot_img = result.plot()
                rgb_img = cv2.cvtColor(plot_img, cv2.COLOR_BGR2RGB)

                # è½¬æ¢ä¸ºQPixmap
                h, w, ch = rgb_img.shape
                bytes_line = ch * w
                qimg = QImage(rgb_img.data, w, h, bytes_line, QImage.Format_RGB888)
                self.result_images.append(QPixmap.fromImage(qimg))

            self.process_result(results)
            self.show_mode = "original"
            self.update_ui_state()

            if len(self.result_images) > 0:
                QMessageBox.information(self, "å®Œæˆ", f"æˆåŠŸæ£€æµ‹ {len(self.result_images)} å¼ å›¾ç‰‡")
            else:
                QMessageBox.warning(self, "è­¦å‘Š", "æœªç”Ÿæˆæœ‰æ•ˆæ£€æµ‹ç»“æœ")

        except Exception as e:
            QMessageBox.critical(self, "é”™è¯¯", f"ç»“æœå¤„ç†å¤±è´¥: {str(e)}")
        finally:
            self.progress_bar.setValue(0)
            self.detect_btn.setEnabled(True)

    def toggle_mode(self):
        """åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼æ—¶æ›´æ–°ç¼©ç•¥å›¾"""
        if not self.result_images:
            QMessageBox.warning(self, "æç¤º", "è¯·å…ˆå®Œæˆæ£€æµ‹")
            return

        self.show_mode = "results" if self.show_mode == "original" else "original"
        self.display_current()
        self.update_ui_state()
        # æ–°å¢ï¼šåˆ‡æ¢æ¨¡å¼æ—¶æ›´æ–°ç¼©ç•¥å›¾åˆ—è¡¨
        self.update_thumbnails()

    def update_thumbnails(self):
        """ä¼˜åŒ–åçš„è™šæ‹Ÿåˆ—è¡¨å®ç°ï¼ˆä¿®å¤é—®é¢˜1ï¼‰"""
        # è·å–å½“å‰å¯è§èŒƒå›´
        scroll_bar = self.thumbnail_list.verticalScrollBar()
        start_idx = max(0, scroll_bar.value() // 110 - 2)
        end_idx = min(len(self.image_paths), start_idx + (self.thumbnail_list.height() // 110) + 4)

        # æ›´æ–°å¯è§é¡¹
        for idx in range(start_idx, end_idx):
            if 0 <= idx < len(self.original_thumbs):
                # æ ¹æ®æ˜¾ç¤ºæ¨¡å¼é€‰æ‹©ç¼©ç•¥å›¾ï¼ˆæ–°å¢éƒ¨åˆ†ï¼‰
                if self.show_mode == "results" and idx < len(self.result_thumbs):
                    thumb = self.result_thumbs[idx]
                    status = "âœ…"
                else:
                    thumb = self.original_thumbs[idx]
                    status = "ğŸ“·"

                # ç”Ÿæˆæ˜¾ç¤ºæ–‡æœ¬
                if thumb:
                    text = f"{status} {self.get_filename(idx)}"
                else:
                    thumb = QPixmap(":/icons/loading.png")
                    text = "åŠ è½½ä¸­..." if idx not in self.failed_loads else "âŒ åŠ è½½å¤±è´¥"

                # æ›´æ–°åˆ—è¡¨é¡¹
                if idx >= self.thumbnail_list.count():
                    item = QListWidgetItem()
                    self.thumbnail_list.insertItem(idx, item)
                else:
                    item = self.thumbnail_list.item(idx)

                item.setIcon(QIcon(thumb))
                item.setText(text)

        # é«˜äº®å½“å‰é¡¹
        if 0 <= self.current_index < self.thumbnail_list.count():
            self.thumbnail_list.setCurrentRow(self.current_index)

    def process_result(self, results):
        """å¤„ç†æ£€æµ‹ç»“æœæ—¶ç”Ÿæˆç»“æœç¼©ç•¥å›¾"""
        self.result_thumbs = []
        for pixmap in self.result_images:
            thumb = pixmap.scaled(100, 100, Qt.KeepAspectRatio, Qt.SmoothTransformation)
            self.result_thumbs.append(thumb)

    def show_prev(self):
        """æ˜¾ç¤ºä¸Šä¸€å¼ å¹¶æ›´æ–°å¯¹æ¯”è§†å›¾"""
        max_index = len(self.image_paths)
        if max_index == 0:
            return

        self.current_index = (self.current_index - 1) % max_index
        self.display_current()
        self.highlight_current_item()

        # æ›´æ–°å¯¹æ¯”è§†å›¾
        if hasattr(self, 'compare_win') and self.compare_win.isVisible():
            self.update_compare_display()

    def show_next(self):
        """æ˜¾ç¤ºä¸‹ä¸€å¼ å¹¶æ›´æ–°å¯¹æ¯”è§†å›¾"""
        max_index = len(self.image_paths)
        if max_index == 0:
            return

        self.current_index = (self.current_index + 1) % max_index
        self.display_current()
        self.highlight_current_item()

        # æ›´æ–°å¯¹æ¯”è§†å›¾
        if hasattr(self, 'compare_win') and self.compare_win.isVisible():
            self.update_compare_display()

    def highlight_current_item(self):
        """ä¿®å¤ï¼šé«˜äº®å½“å‰åˆ—è¡¨é¡¹"""
        if 0 <= self.current_index < self.thumbnail_list.count():
            item = self.thumbnail_list.item(self.current_index)
            item.setSelected(True)
            self.thumbnail_list.scrollToItem(item, QAbstractItemView.PositionAtCenter)

    def save_current(self):
        """ä¿å­˜å½“å‰æ˜¾ç¤ºçš„å†…å®¹"""
        if self.show_mode == "original":
            pixmap = self.original_images[self.current_index]
            default_name = f"åŸå§‹_{self.current_index + 1}.jpg"
        else:
            pixmap = self.result_images[self.current_index]
            default_name = f"ç»“æœ_{self.current_index + 1}.jpg"

        path, _ = QFileDialog.getSaveFileName(
            self, "ä¿å­˜å›¾ç‰‡",
            default_name,
            "JPEGæ–‡ä»¶ (*.jpg);;PNGæ–‡ä»¶ (*.png)"
        )

        if path and pixmap:
            if not pixmap.save(path):
                QMessageBox.warning(self, "é”™è¯¯", "ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œæƒé™")

    def show_compare(self):
        """æ˜¾ç¤ºå¯¹æ¯”è§†å›¾"""
        if len(self.result_images) == 0:
            return

        # å…³é—­å·²å­˜åœ¨çš„å¯¹æ¯”çª—å£
        if hasattr(self, 'compare_win') and self.compare_win:
            self.compare_win.close()

        # åˆ›å»ºå¯¹æ¯”çª—å£
        self.compare_win = QMainWindow(self)
        self.compare_win.setWindowTitle("å¯¹æ¯”è§†å›¾")
        self.compare_win.resize(1280, 600)

        # ä¸»å¸ƒå±€
        central_widget = QWidget()
        self.compare_win.setCentralWidget(central_widget)
        layout = QVBoxLayout(central_widget)

        # å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸ
        image_widget = QWidget()
        image_layout = QHBoxLayout(image_widget)
        self.original_compare_label = QLabel()
        self.result_compare_label = QLabel()
        image_layout.addWidget(self.original_compare_label)
        image_layout.addWidget(QLabel("â†’"))
        image_layout.addWidget(self.result_compare_label)
        layout.addWidget(image_widget)

        # æ§åˆ¶æŒ‰é’®
        control_widget = QWidget()
        control_layout = QHBoxLayout(control_widget)
        self.compare_prev_btn = QPushButton("â† ä¸Šä¸€å¼ ")
        self.compare_next_btn = QPushButton("ä¸‹ä¸€å¼  â†’")
        control_layout.addWidget(self.compare_prev_btn)
        control_layout.addWidget(self.compare_next_btn)
        layout.addWidget(control_widget)

        # è¿æ¥ä¿¡å·
        self.compare_prev_btn.clicked.connect(self.show_prev)
        self.compare_next_btn.clicked.connect(self.show_next)

        # åˆå§‹æ˜¾ç¤º
        self.update_compare_display()
        self.compare_win.show()
        self.compare_win.destroyed.connect(lambda: self.cleanup_compare_window())

    def cleanup_compare_window(self):
        """æ¸…ç†å¯¹æ¯”çª—å£èµ„æº"""
        if hasattr(self, 'compare_win'):
            del self.compare_win

    def update_compare_display(self):
        """æ›´æ–°å¯¹æ¯”è§†å›¾ä¸­çš„å›¾ç‰‡æ˜¾ç¤ºï¼ˆä¿®å¤é—®é¢˜2ï¼‰"""
        if not hasattr(self, 'compare_win') or not self.compare_win:
            return

        # è·å–å½“å‰å›¾ç‰‡
        original_pix = self.original_images[self.current_index]
        result_pix = self.result_images[self.current_index]

        # ä½¿ç”¨å›ºå®šå°ºå¯¸è¿›è¡Œç¼©æ”¾ï¼ˆä¿®å¤å°ºå¯¸é€’å‡é—®é¢˜ï¼‰
        target_width = 600  # å›ºå®šå®½åº¦
        target_height = 600  # å›ºå®šé«˜åº¦

        # è®¡ç®—ä¿æŒæ¯”ä¾‹çš„ç¼©æ”¾
        scaled_original = original_pix.scaled(
            target_width, target_height,
            Qt.KeepAspectRatio,
            Qt.SmoothTransformation
        )
        scaled_result = result_pix.scaled(
            target_width, target_height,
            Qt.KeepAspectRatio,
            Qt.SmoothTransformation
        )

        # æ›´æ–°æ˜¾ç¤º
        self.original_compare_label.setPixmap(scaled_original)
        self.result_compare_label.setPixmap(scaled_result)

    def resizeEvent(self, event):
        self.display_current()


if __name__ == '__main__':
    app = QApplication(sys.argv)
    try:
        window = CrackDetectionApp()
        window.show()
        sys.exit(app.exec_())
    except Exception as e:
        QMessageBox.critical(None, "é”™è¯¯", f"ç¨‹åºå¯åŠ¨å¤±è´¥: {str(e)}")



 # æ¨¡æ‹Ÿæ‘„åƒå¤´æ§åˆ¶åŒºåŸŸ
        camera_widget = QWidget()
        camera_layout = QVBoxLayout(camera_widget)
        self.camera_label = QLabel()
        self.camera_label.setStyleSheet("background-color: #404040; border-radius: 10px; padding: 10px;")
        self.start_camera_btn = QPushButton("ğŸ“· å¯åŠ¨æ‘„åƒå¤´")
        self.stop_camera_btn = QPushButton("ğŸ›‘ åœæ­¢æ‘„åƒå¤´")
        self.start_camera_btn.clicked.connect(self.start_camera_detection)
        self.stop_camera_btn.clicked.connect(self.stop_camera_detection)
        self.stop_camera_btn.setEnabled(False)
        camera_layout.addWidget(self.camera_label)
        camera_layout.addWidget(self.start_camera_btn)
        camera_layout.addWidget(self.stop_camera_btn)
        left_layout.addWidget(camera_widget)